# Ruby King Bot - Модульная Архитектура

## Обзор

Ruby King Bot был рефакторен с монолитной архитектуры (862 строки в main.py) на модульную архитектуру с четким разделением ответственности.

## Структура проекта

```
ruby_king_bot/
├── main.py                    # Точка входа (упрощена до 50 строк)
├── api/                       # API взаимодействие
│   ├── client.py             # HTTP клиент для API
│   └── endpoints.py          # API эндпоинты
├── core/                      # Основные игровые сущности
│   ├── game_state.py         # Управление состояниями игры
│   ├── player.py             # Игрок и его характеристики
│   └── mob.py                # Мобы и группы мобов
├── logic/                     # Игровая логика (НОВЫЙ МОДУЛЬ)
│   ├── game_engine.py        # Основной игровой движок
│   ├── combat_handler.py     # Обработка боевой логики
│   ├── exploration_handler.py # Обработка исследования
│   ├── rest_handler.py       # Обработка отдыха
│   └── data_extractor.py     # Извлечение данных из API
├── ui/                        # Пользовательский интерфейс
│   └── display.py            # Консольный UI
├── config/                    # Конфигурация
│   ├── settings.py           # Настройки игры
│   └── token.py              # Токен авторизации
└── utils/                     # Утилиты
    └── item_database.py      # База данных предметов
```

## Модули и их ответственность

### 1. GameEngine (`logic/game_engine.py`)
**Основной игровой движок**

- Управляет главным игровым циклом
- Координирует все компоненты системы
- Обрабатывает переходы между состояниями
- Обновляет UI в реальном времени

**Ключевые методы:**
- `run()` - главный игровой цикл
- `_handle_city_state()` - обработка состояния города
- `_handle_combat_state()` - обработка боевого состояния
- `_handle_resting_state()` - обработка состояния отдыха

### 2. CombatHandler (`logic/combat_handler.py`)
**Обработчик боевой логики**

- Управляет атаками и скиллами
- Обрабатывает использование зелий
- Анализирует результаты боя
- Обновляет статистику

**Ключевые методы:**
- `handle_combat_round()` - обработка одного раунда боя
- `_use_skill()` - использование скилла
- `_use_attack()` - обычная атака
- `_use_healing_potion()` - использование зелья лечения

### 3. ExplorationHandler (`logic/exploration_handler.py`)
**Обработчик исследования территории**

- Выполняет исследование территории
- Обрабатывает ошибки исследования
- Логирует API ответы

### 4. RestHandler (`logic/rest_handler.py`)
**Обработчик отдыха**

- Управляет отдыхом у костра
- Обрабатывает восстановление морали

### 5. DataExtractor (`logic/data_extractor.py`)
**Извлечение данных из API**

- Извлекает данные мобов из API ответов
- Форматирует данные для отображения
- Обрабатывает различные форматы ответов

## Преимущества новой архитектуры

### 1. Разделение ответственности
- Каждый модуль отвечает за свою область
- Легко найти и исправить проблемы
- Простое тестирование отдельных компонентов

### 2. Масштабируемость
- Легко добавлять новые функции
- Можно расширять отдельные модули
- Поддержка новых игровых механик

### 3. Читаемость кода
- main.py сокращен с 862 до 50 строк
- Логика разделена по функциональности
- Четкие интерфейсы между модулями

### 4. Удобство редактирования
- Изменения в боевой логике - только в CombatHandler
- Изменения в UI - только в Display
- Изменения в API - только в API модулях

## Примеры использования

### Добавление новой боевой способности
```python
# В combat_handler.py
def _use_new_ability(self, current_target: Mob, current_time: float):
    # Новая логика способности
    pass
```

### Изменение логики исследования
```python
# В exploration_handler.py
def explore_territory(self) -> Optional[Dict[str, Any]]:
    # Новая логика исследования
    pass
```

### Добавление нового состояния игры
```python
# В game_state.py
class GameState(Enum):
    NEW_STATE = "new_state"

# В game_engine.py
def _handle_new_state(self):
    # Обработка нового состояния
    pass
```

## Миграция с старой архитектуры

### Что изменилось:
1. **main.py** - теперь только точка входа
2. **Игровая логика** - перенесена в модули logic/
3. **Обработка данных** - вынесена в DataExtractor
4. **Боевая логика** - изолирована в CombatHandler

### Что осталось без изменений:
1. **API клиент** - работает как прежде
2. **UI система** - добавлен только метод get_live_display()
3. **Конфигурация** - настройки не изменились
4. **Игровые сущности** - Player, Mob, GameState остались

## Рекомендации по разработке

### 1. Добавление новых функций
- Определите, к какому модулю относится функциональность
- Добавьте методы в соответствующий модуль
- Обновите интерфейсы при необходимости

### 2. Отладка
- Логирование остается в каждом модуле
- Используйте debug режим для детального анализа
- Проверяйте API ответы в logs/api_responses.log

### 3. Тестирование
- Каждый модуль можно тестировать отдельно
- Создавайте unit тесты для логических компонентов
- Используйте mock данные для API тестирования

## Заключение

Новая модульная архитектура делает Ruby King Bot более:
- **Поддерживаемым** - легко найти и исправить проблемы
- **Расширяемым** - просто добавлять новые функции
- **Тестируемым** - каждый модуль можно тестировать отдельно
- **Читаемым** - код организован логически

Это обеспечивает долгосрочную стабильность и развитие проекта. 